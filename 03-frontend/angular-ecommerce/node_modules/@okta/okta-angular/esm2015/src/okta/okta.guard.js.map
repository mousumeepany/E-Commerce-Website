{"version":3,"file":"okta.guard.js","sources":["../../package/src/okta/okta.guard.ts"],"names":[],"mappings":"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","sourcesContent":["/*\n * Copyright (c) 2017-Present, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *\n * See the License for the specific language governing permissions and limitations under the License.\n */\n\nimport { Injectable, Injector } from '@angular/core';\nimport {\n  CanActivate,\n  CanActivateChild,\n  ActivatedRouteSnapshot,\n  RouterStateSnapshot,\n  Router,\n  NavigationStart\n} from '@angular/router';\nimport { filter } from 'rxjs/operators';\n\nimport { AuthState } from '@okta/okta-auth-js';\n\nimport { OktaAuthService } from './services/okta.service';\nimport { AuthRequiredFunction } from './models/okta.config';\n\n@Injectable()\nexport class OktaAuthGuard implements CanActivate, CanActivateChild {\n  private route: ActivatedRouteSnapshot;\n  private state: RouterStateSnapshot;\n\n  constructor(private oktaAuth: OktaAuthService, private injector: Injector) { \n    // Unsubscribe updateAuthStateListener when route change\n    const router = injector.get(Router);\n    router.events.pipe(\n      filter((e: Event) => e instanceof NavigationStart && this.state && this.state.url !== e.url)\n    ).subscribe(() => {\n      this.oktaAuth.authStateManager.unsubscribe(this.updateAuthStateListener);\n    });\n  }\n\n  /**\n   * Gateway for protected route. Returns true if there is a valid accessToken,\n   * otherwise it will cache the route and start the login flow.\n   * @param route\n   * @param state\n   */\n  async canActivate(route: ActivatedRouteSnapshot, state: RouterStateSnapshot): Promise<boolean> {\n    // Track states for current route\n    this.route = route;\n    this.state = state;\n\n    // Protect the route after accessing\n    this.oktaAuth.authStateManager.subscribe(this.updateAuthStateListener);\n    const isAuthenticated = await this.oktaAuth.isAuthenticated();\n    if (isAuthenticated) {\n      return true;\n    }\n\n    await this.handleLogin(state.url);\n\n    return false;\n  }\n\n  async canActivateChild(\n    route: ActivatedRouteSnapshot,\n    state: RouterStateSnapshot\n  ): Promise<boolean> {\n    return this.canActivate(route, state);\n  }\n\n  private async handleLogin(fromUri: string): Promise<void> {\n     // Get the operation to perform on failed authentication from\n     // either the global config or route data injection.\n    const onAuthRequired: AuthRequiredFunction = this.route.data['onAuthRequired'] || this.oktaAuth.getOktaConfig().onAuthRequired;\n    \n    // Store the current path\n    this.oktaAuth.setOriginalUri(fromUri);\n\n    if (onAuthRequired) {\n      onAuthRequired(this.oktaAuth, this.injector);\n    } else {\n      this.oktaAuth.signInWithRedirect();\n    }\n  }\n\n  private updateAuthStateListener = (authState: AuthState) => {\n    if (!authState.isAuthenticated) {\n      this.handleLogin(this.state.url);\n    }\n  };\n\n}\n"]}